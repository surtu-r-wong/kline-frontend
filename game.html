<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¸¸æˆè¿›è¡Œä¸­</title>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts/dist/lightweight-charts.standalone.production.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #f7f9fc; color: #333; }
    .container { max-width: 600px; margin: 20px auto; padding: 20px; min-height: 100vh; }
    h2 { text-align: center; color: #1a73e8; margin-bottom: 5px; }
    #nickname-display { text-align: center; color: #666; margin: 5px 0; }
    #chart { height: 300px; border-radius: 10px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 15px 0; }
    #choices { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
    button {
      padding: 12px 24px; font-size: 16px; border: none; border-radius: 8px;
      cursor: pointer; flex: 1; max-width: 45%; font-weight: bold;
    }
    button:first-child { background: #26a69a; color: white; }
    button:last-child { background: #ef5350; color: white; }
    .result-box {
      background: white; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-top: 10px;
    }
    .result-box p { color: #555; margin-bottom: 15px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="title">åŠ è½½ä¸­...</h2>
    <div id="nickname-display">ğŸ® ç©å®¶</div>
    <div id="chart"></div>
    <div id="choices">
      <button onclick="bet('long')">ğŸ“ˆ åšå¤š</button>
      <button onclick="bet('short')">ğŸ“‰ åšç©º</button>
    </div>
    <div id="result" class="result-box" style="display:none;">
      <h3 id="resultText"></h3>
      <p id="detailInfo"></p>
      <button onclick="location.href='/'">ğŸ  è¿”å›é¦–é¡µ</button>
      <button onclick="restart()">ğŸ” å†æ¥ä¸€å±€</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('c');
    const timeframe = urlParams.get('t');
    let chart, candleSeries, gameData;

    // è·å–ç”¨æˆ·æ˜µç§°
    let USER_NICKNAME = "ç©å®¶";
    window.addEventListener("load", () => {
      const saved = localStorage.getItem("user_nickname");
      let name = saved || prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼ˆå¯éšæ—¶æ›´æ”¹ï¼‰ï¼š", saved || "Kçº¿çŒæ‰‹");
      if (!name || name.trim() === "") name = "ç¥ç§˜ç©å®¶";
      USER_NICKNAME = name.trim().substring(0, 20);
      localStorage.setItem("user_nickname", USER_NICKNAME);
      document.getElementById("nickname-display").innerText = `ğŸ® ${USER_NICKNAME}`;
    });

    async function loadGame() {
      const res = await fetch(`/api/start?category=${category}&timeframe=${timeframe}`);
      gameData = await res.json();

      if (gameData.error) {
        if (gameData.limited) {
          alert(`âš ï¸ ä»Šæ—¥ã€${getCategoryName(category)} - ${timeframe==='daily'?'æ—¥é—´':'æ—¥å†…'}ã€‘å·²è¾¾5æ¬¡ä¸Šé™\nè¯·æ˜å¤©å†æ¥æˆ–å°è¯•å…¶ä»–ç±»åˆ«ï¼`);
          if (confirm("æŸ¥çœ‹æ’è¡Œæ¦œï¼Ÿ")) location.href = "/leaderboard";
          else location.href = "/";
          return;
        } else {
          alert("æ•°æ®åŠ è½½å¤±è´¥ï¼š" + gameData.error);
          history.back();
          return;
        }
      }

      document.getElementById("title").innerText = `ã€${gameData.asset_name}ã€‘- ${timeframe==='daily'?'æ—¥é—´':'æ—¥å†…'}æ¨¡å¼`;

      chart = LightweightCharts.createChart(document.getElementById("chart"), {
        layout: { backgroundColor: '#fff', textColor: '#333' },
        grid: { vertLines: { color: '#eee' }, horzLines: { color: '#eee' } },
        timeScale: { timeVisible: true, borderColor: '#ddd' },
        height: 300
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        borderUpColor: '#26a69a', borderDownColor: '#ef5350',
        wickUpColor: '#26a69a', wickDownColor: '#ef5350'
      });

      const volumeSeries = chart.addHistogramSeries({
        color: '#26a69a', priceFormat: { type: 'volume' },
        scaleMargin: { top: 0.7, bottom: 0.1 }
      });
      volumeSeries.setTitle("æˆäº¤é‡");

      const secondarySeries = chart.addHistogramSeries({
        color: '#7e57c2', priceFormat: { precision: 2, minMove: 0.01 },
        scaleMargin: { top: 0.85, bottom: 0.1 }
      });

      let secondaryLabel = "";
      if (category === "commodity_futures") {
        secondaryLabel = "æŒä»“é‡";
      } else if (["a_share", "h_share", "us_stock"].includes(category)) {
        secondaryLabel = "æ¢æ‰‹ç‡(%)";
      } else {
        secondaryLabel = "è¾…åŠ©æŒ‡æ ‡";
      }
      secondarySeries.setTitle(secondaryLabel);

      const primaryData = gameData.visible_candles.map(d => ({
        time: d.date,
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close
      }));
      candleSeries.setData(primaryData);

      const volumeData = gameData.visible_candles.map(d => ({
        time: d.date,
        value: d.volume || 0,
        color: d.close >= d.open ? '#26a69a' : '#ef5350'
      }));
      volumeSeries.setData(volumeData);

      const secondaryData = gameData.visible_candles.map(d => {
        let val = null;
        if (category === "commodity_futures") {
          val = d.position;
        } else if (["a_share", "h_share", "us_stock"].includes(category)) {
          val = d.turnover;
        } else {
          val = d.volume ? d.volume / 1000 : 0;
        }
        return {
          time: d.date,
          value: val,
          color: '#7e57c2'
        };
      });
      secondarySeries.setData(secondaryData);
    }

    function getCategoryName(key) {
      const names = {
        'commodity_futures': 'å•†å“æœŸè´§','a_share': 'Aè‚¡','h_share': 'æ¸¯è‚¡',
        'us_stock': 'ç¾è‚¡','crypto': 'åŠ å¯†è´§å¸'
      };
      return names[key] || key;
    }

    function bet(dir) {
      const initial = gameData.visible_candles.at(-1).close;
      const final = gameData.full_candles.at(-1).close;
      const correct = (dir === 'long' && final > initial) || (dir === 'short' && final < initial);

      const full = gameData.full_candles.map(c => ({ time: c.date, ...c }));
      candleSeries.setData(full);

      const resultBox = document.getElementById("result");
      document.getElementById("choices").style.display = "none";
      resultBox.style.display = "block";

      const rt = document.getElementById("resultText");
      rt.innerText = correct ? "ğŸ‰ é¢„æµ‹æ­£ç¡®ï¼" : "ğŸ’” é¢„æµ‹é”™è¯¯â€¦";
      rt.style.color = correct ? "green" : "red";

      const change = ((final - initial) / initial * 100).toFixed(2);
      document.getElementById("detailInfo").innerHTML = `
        èµ·å§‹ä»·: ${initial.toFixed(2)} â†’ æœ€ç»ˆä»·: ${final.toFixed(2)}<br>
        æ¶¨è·Œå¹…: ${change > 0 ? '+' : ''}${change}%<br>
        <strong>ä½ çš„åˆ¤æ–­ï¼š${dir === 'long' ? 'åšå¤š' : 'åšç©º'}</strong><br>
        <small>æ•°æ®æ¥è‡ªçœŸå®å†å²è¡Œæƒ…</small>
      `;

      fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          game_data: gameData,
          player_choice: dir,
          nickname: USER_NICKNAME
        })
      }).catch(console.error);
    }

    function restart() {
      location.reload();
    }

    window.onload = loadGame;
  </script>
</body>
</html>

