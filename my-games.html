<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æˆ‘çš„æˆ˜ç»© - Kçº¿æŒ‘æˆ˜</title>
  <link rel="stylesheet" href="/static/assets/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“œ æˆ‘çš„æˆ˜ç»©</h1>
    <p>å›é¡¾ä½ çš„æ¯ä¸€å±€é¢„æµ‹ä¸å¸‚åœºçœŸå®èµ°åŠ¿</p>

    <div id="loading">åŠ è½½ä¸­...</div>
    <div id="games-list" style="display:none;"></div>

    <button onclick="generateShareImage()" style="width:100%;margin:20px 0;">
      ğŸ“¸ ç”Ÿæˆåˆ†äº«å›¾
    </button>

    <footer>
      <a href="/">ğŸ  è¿”å›é¦–é¡µ</a> | 
      <a href="/leaderboard">ğŸ† æ’è¡Œæ¦œ</a>
    </footer>
  </div>

  <script>
    // è·å–ç”¨æˆ·IDï¼ˆåŸºäºè®¾å¤‡æŒ‡çº¹ï¼‰
    function getOrCreateUserId() {
      let uid = localStorage.getItem("user_id");
      if (!uid) {
        const parts = [
          navigator.userAgent,
          screen.width + "x" + screen.height,
          navigator.language,
          new Date().getTimezoneOffset(),
          Math.random()
        ].join("|");
        let hash = 0;
        for (let i = 0; i < parts.length; i++) {
          const char = parts.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
        }
        uid = "uid_" + Math.abs(hash).toString(36).substr(0, 16);
        localStorage.setItem("user_id", uid);
      }
      return uid;
    }

    const USER_ID = getOrCreateUserId();
    const USER_NICKNAME = localStorage.getItem("user_nickname") || "ç©å®¶";

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(dateTimeStr) {
      return dateTimeStr.replace('T', ' ').slice(0, 16);
    }

    // åŠ è½½æˆ‘çš„æ¸¸æˆè®°å½•
    async function loadMyGames() {
      try {
        const res = await fetch(`/api/my-games?user_id=${USER_ID}`);
        const data = await res.json();
        const container = document.getElementById("games-list");
        const loading = document.getElementById("loading");

        if (!data.data || data.data.length === 0) {
          container.innerHTML = "<p style='text-align:center;color:#999;'>æš‚æ— æ¸¸æˆè®°å½•</p>";
        } else {
          container.innerHTML = data.data.map(g => `
            <div style="background:white;padding:15px;border-radius:10px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
              <strong>${g.asset_name} (${g.symbol})</strong> 
              <span style="color:#999;font-size:12px;">${formatTime(g.played_at)}</span><br>
              <small>${g.timeframe === 'daily' ? 'æ—¥é—´' : 'æ—¥å†…'} â€¢ ${g.category_text}</small><br><br>
              
              <div style="font-size:14px;line-height:1.5;">
                ğŸ”¹ ä¸‹å•ç‚¹ä½ï¼š<strong>${g.entry_price.toFixed(2)}</strong><br>
                ğŸ”¹ å®é™…èµ°åŠ¿ï¼š<strong style="color:${g.direction==='up'?'#26a69a':'#ef5350'};">
                  ${g.direction==='up'?'ä¸Šæ¶¨':'ä¸‹è·Œ'}
                </strong> (${g.return_pct > 0 ? '+' : ''}${g.return_pct.toFixed(2)}%)<br>
                ğŸ”¹ ä½ çš„é€‰æ‹©ï¼š<strong>${g.player_choice === 'long' ? 'ğŸ“ˆ åšå¤š' : 'ğŸ“‰ åšç©º'}</strong> â†’ 
                <strong style="color:${g.is_correct ? '#26a69a' : '#ef5350'};">
                  ${g.is_correct ? 'æ­£ç¡® âœ…' : 'é”™è¯¯ âŒ'}
                </strong>
              </div>
            </div>
          `).join('');
        }
        loading.style.display = "none";
        container.style.display = "block";
      } catch (e) {
        console.error("åŠ è½½æˆ˜ç»©å¤±è´¥:", e);
        alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯æ˜¯å¦è¿è¡Œã€‚");
      }
    }

    // ç”Ÿæˆåˆ†äº«å›¾ç‰‡
    function generateShareImage() {
      const container = document.createElement('div');
      container.style.cssText = `
        position: fixed; top: -9999px; width: 375px; background: white; 
        font-family: -apple-system, sans-serif; padding: 20px; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 14px;
      `;

      const now = new Date().toLocaleDateString('zh-CN');
      const games = document.querySelectorAll("#games-list > div");
      const recentHtml = Array.from(games).slice(0, 3).map(el => el.outerHTML).join('');

      container.innerHTML = `
        <h3 style="color:#1a73e8;text-align:center;">Kçº¿æŒ‘æˆ˜ Â· æˆ‘çš„æˆ˜ç»©</h3>
        <p style="color:#666;text-align:center;">ğŸ® ${USER_NICKNAME}</p>
        <hr style="border:1px solid #eee;margin:10px 0;">
        <p><strong>ğŸ“Š æœ€è¿‘æˆ˜ç»©</strong>ï¼ˆæˆªè‡³ ${now}ï¼‰</p>
        ${recentHtml}
        <p style="color:#999;font-size:12px;margin-top:20px;text-align:center;">
          æ•°æ®æ¥è‡ªçœŸå®å†å²è¡Œæƒ…<br>
          #Kçº¿æŒ‘æˆ˜ #æŠ•èµ„æ€ç»´è®­ç»ƒ
        </p>
      `;

      document.body.appendChild(container);

      setTimeout(() => {
        html2canvas(container, { 
          backgroundColor: 'white',
          scale: 2,
          useCORS: true,
          logging: false
        }).then(canvas => {
          const img = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.download = `kline-challenge-${Date.now()}.png`;
          link.href = img;
          link.click();
          document.body.removeChild(container);
        }).catch(err => {
          console.error("æˆªå›¾å¤±è´¥:", err);
          alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
          document.body.removeChild(container);
        });
      }, 500);
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æˆ˜ç»©
    window.onload = loadMyGames;
  </script>
</body>
</html>

